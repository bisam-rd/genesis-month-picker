<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../genesis-popover/genesis-popover.html">

<link rel="import" href="../vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../vaadin-button/vaadin-button.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../vaadin-icons/vaadin-icons.html">

<dom-module id="genesis-month-picker">
  <template>
    <style>
      genesis-popover {   
        --genesis-popover-max-width:230px;
      }

      :host {
        display: block;
      }

      [part="column-slot"] {
        display: flex;
        flex-direction: column;
        flex:1;
        align-items: center
      }

      [part="months_div"] {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row;
        justify-content: center;
      }

      [part="months_div"] vaadin-button {
        margin-right: 3px;
        margin-left: 3px;
      }

      [part="year-field"] {
        display: flex;
      }

      [part="year-field"] * {
        margin-top: auto;
        margin-bottom: auto;
      }
     
 
    </style>
  
    <genesis-popover placement="bottom-start" id="danyskays">
        <span>
          <vaadin-text-field id="kylie" placeholder="Date" locale="[[locale]]" value="{{renderedValue}}"> <!-- prevent-invalid-input pattern="\d*/*\d*/*\d*/*" -->
            <iron-icon icon="vaadin:calendar" slot="suffix"></iron-icon><!--on-click="update"--> 
          </vaadin-text-field>
        </span>
        <div slot="content" part="content-slot">
            <div part="column-slot">
                <div part="year-field">
                    <iron-icon icon="vaadin:caret-left" on-click="previousYear"></iron-icon>
                      <vaadin-text-field value="{{year}}" prevent-invalid-input pattern="\d*" theme="align-center"></vaadin-text-field>
                    <iron-icon icon="vaadin:caret-right" on-click="nextYear" ></iron-icon>
                </div>
                
                <div id="months_div" part="months_div"></div>       
            </div>
        </div>
    </genesis-popover>
  </template>

  <script>
    /**
     * `genesis-month-picker`
     * The Genesis Month Picker is a component that allows to navigate quickly between months to select an end month date.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class GenesisMonthPicker extends
     Polymer.Element {
      static get is() { return 'genesis-month-picker'; }

      ready() {
        super.ready();
        
        Array.from(Array(12).keys()).forEach(v=>{
          let month=document.createElement('vaadin-button');
          month.appendChild(document.createTextNode(this.localeMonth(v)));
          month.addEventListener('click', e => {this.updateField(new Date(this.year, v+1, 0))});
          this.$.months_div.appendChild(month);    
        });

        this.renderedValue=this.formatDate(this.value);
        this.year=this.value.getFullYear();

      }

      update(){
        this.$.danyskays.setAttribute('pressed','true');
      }

      updateField(date) {
        this.$.kylie.setAttribute('value',this.formatDate(date));
      }

      previousYear(field) {
        this.year--;
      }

      nextYear(field) {
        this.year++;
      }

      formatDate(date){
        return new Date(date.getFullYear(), date.getMonth()+1, 0).toLocaleDateString(this.locale);
      }

      localeMonth(monthNum){
        let monthName=new Date(2000, monthNum, 1).toLocaleDateString(this.locale, {month:'short'});
        return monthName.charAt(0).toUpperCase()+monthName.substring(1);
      }


       _yearChanged(newValue, oldValue){
         if(newValue!="" && newValue!=oldValue)
         {
            this.value.setYear(newValue);
            this.renderedValue = this.formatDate(this.value);
         }
      }

      static get properties() {
        return {
          value: {
            type: Date,
            reflectToAttribute: true,
            value: new Date()
          },
          
          locale: {
            type: String,
            value: 'fr-FR'
          },

          year: {
            type: Number,
            observer: '_yearChanged',
            reflectToAttribute: true
          },

          renderedValue: {
            type: String,
            reflectToAttribute: true
          }
        };
      }
    }

    window.customElements.define(GenesisMonthPicker.is, GenesisMonthPicker);
  </script>
</dom-module>
